using MailKit.Net.Smtp;
using MailKit.Security;
using Microsoft.Extensions.Options;
using MimeKit;
using System.Text;
using VulnerabilityMonitoring.Models.Config;
using VulnerabilityMonitoring.Models.ViewModels;

namespace VulnerabilityMonitoring.Services.Email
{
    public interface ISendEmail
    {
        Task SendEmailAsync(MimeMessage message);
        Task SendVulnerabilityWarningEmailAsync(VulnerableProjectViewModels viewModel);
    }

    public class SendEmail : ISendEmail
    {
        private readonly EmailSettings _emailSettings;
        private readonly ILogger<SendEmail> _logger;
        private readonly IAccountService _accountService;
        //private static int emailCount = 0;
        public SendEmail(IOptions<EmailSettings> emailSettings, ILogger<SendEmail> logger, IAccountService accountService)
        {
            _emailSettings = emailSettings.Value;
            _logger = logger;
            _accountService = accountService;
        }


        public async Task SendVulnerabilityWarningEmailAsync(VulnerableProjectViewModels viewModel)
        {
            var users = await _accountService.GetAllUserProfileAsync();
            foreach (var user in users)
            {
                var emailBodyBuilder = new StringBuilder();
                bool sendEmail = false;

                // Nu hanterar vi bara ett projekt per ViewModel
                bool projectHasRelevantVulnerabilities = viewModel.VulnerableProjectPackage.Any(
                    vp => (vp.Severity == "High" && user.EnableHighSeverity) ||
                          (vp.Severity == "Moderate" && user.EnableModerateSeverity) ||
                          (vp.Severity == "Critical" && user.EnableCriticalSeverity) ||
                          user.EnableAllSeverity);

                if (projectHasRelevantVulnerabilities)
                {
                    sendEmail = true;
                    emailBodyBuilder.AppendLine($"Project: {viewModel.RepositoryName} has vulnerabilities. Please take action immediately.");
                    foreach (var package in viewModel.VulnerableProjectPackage)
                    {
                        if ((package.Severity == "High" && user.EnableHighSeverity) ||
                            (package.Severity == "Moderate" && user.EnableModerateSeverity) ||
                            (package.Severity == "Critical" && user.EnableCriticalSeverity) ||
                            user.EnableAllSeverity)
                        {
                            emailBodyBuilder.AppendLine($"- {package.PackageName} has a {package.Severity} severity vulnerability.");
                        }
                    }
                    emailBodyBuilder.AppendLine();
                }

                if (sendEmail)
                {
                    await SendEmailForProject(user.Email, emailBodyBuilder.ToString(), viewModel.ProjectSloName);
                }
            }
        }

        private async Task SendEmailForProject(string recipientEmail, string emailBody, string projectName)
        {
            var message = new MimeMessage();
            message.From.Add(new MailboxAddress(_emailSettings.SenderName, _emailSettings.Username));
            message.To.Add(new MailboxAddress(recipientEmail, recipientEmail));
            message.Subject = $"Vulnerability Warning for {projectName}";

            var builder = new BodyBuilder
            {
                TextBody = emailBody
            };

            message.Body = builder.ToMessageBody();

            try
            {
                using (var client = new SmtpClient())
                {
                    await client.ConnectAsync(_emailSettings.Host, _emailSettings.Port, SecureSocketOptions.StartTls);
                    await client.AuthenticateAsync(_emailSettings.Username, _emailSettings.Password);
                    await client.SendAsync(message);
                    await client.DisconnectAsync(true);
                    _logger.LogInformation($"Email sent successfully for project: {projectName} to: {recipientEmail}");
                }
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error sending email for project: {projectName}: {ex}");
            }
        }


        public Task SendEmailAsync(MimeMessage message)
        {
            return Task.CompletedTask;
        }
    }
}
